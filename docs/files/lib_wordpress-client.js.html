<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib\wordpress-client.js - wordpress-client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http://media.usabilitydynamics.com/logo.png" title="wordpress-client"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib\wordpress-client.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

/**
 * WordPress Client.
 *
 * @todo Add support for 30X redirect.
 *
 * ### Events
 * * ready          - Once client instance created.
 * * connected      - Once client instance created and list of supported methods is returned.
 * * authenticated  - Once client instance created and list of supported methods is returned.
 * * error          - Emitted on any response error.
 *
 * ### Settings
 * * url            - URL to XML-RPC endpoint.
 * * username       - Username to use.
 * * password       - Password to use.
 * * blog           - ID of blog
 * * key            - As an alternative to usrname and password, if WordPress site supports it.
 * * methods        - Set with supported RPC methods once client connection is created.
 *
 * @param settings
 * @param callback
 * @returns {Client}
 * @constructor
 */
function Client(settings, callback) {
  this.debug(&#x27;new Client&#x27;, settings.url);

  // Mixing settings and emitter into instance.
  require(&#x27;object-emitter&#x27;).mixin(this);
  require(&#x27;object-settings&#x27;).mixin(this);

  // Set defaults and instance settings.
  this.set(Client.defaults).set(settings);

  // Set properties from parsed URL.
  this.set(&#x27;hostname&#x27;, this.common.parseURL(this.get(&#x27;url&#x27;)).hostname);
  this.set(&#x27;auth&#x27;, this.common.parseURL(this.get(&#x27;url&#x27;)).auth);

  // Instance Properties.
  Object.defineProperties(this, {
    __client: {
      value: this.common.createClient({
        url: settings.url,
        username: settings.username,
        password: settings.password,
        blogId: settings.blog || settings.blogId
      }),
      enumerable: false,
      configurable: true,
      writable: false
    },
    __queue: {
      value: [],
      enumerable: false,
      configurable: true,
      writable: false
    }
  });

  // Schedule initial RPC call to verify target is valid.
  this.listMethods(this.onceReady.bind(this));

  // Emit ready event on next tick.
  this.nextTick(this.emit, &#x27;ready&#x27;, null, this);

  // Schedule callback, if provided.
  if (&#x27;function&#x27; === typeof callback) {
    this.once(&#x27;connected&#x27;, callback);
  }

  // @chainable
  return this;

}

/**
 * Instance Properties.
 *
 */
Object.defineProperties(Client.prototype, {
  onceReady: {
    /**
     * Callback for Connection Verification.
     *
     * @todo Does not verify credentials.
     *
     * @param error
     * @param methods
     * @returns {*}
     */
    value: function onceReady(error, methods) {
      this.debug(error ? &#x27;No methods (%d) found, unable to connect to %s.&#x27; : &#x27;onceReady: Found %d methods on %s.&#x27;, ( methods ? methods.length : 0 ), this.get(&#x27;url&#x27;));

      // Set Methods.
      this.set(&#x27;methods&#x27;, methods || []);

      if (error) {
        this.emit(&#x27;error&#x27;, error, this);
      }

      this.emit(&#x27;connected&#x27;, error, this);

      // @chainable
      return this;

    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  listMethods: {
    /**
     * Get Client Methods.
     *
     * @param callback
     * @returns {*}
     */
    value: function listMethods(callback) {
      this.debug(&#x27;listMethods&#x27;);
      this.__client.listMethods(callback);
      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  methodCall: {
    /**
     * Call Method
     *
     * @todo Add __queue use for request batching.
     *
     * @param method
     * @param args
     * @param callback
     * @returns {*}
     */
    value: function methodCall(method, args, callback) {
      this.debug(&#x27;methodCall&#x27;, method);

      var self = this;
      var body = [].slice.call(args, 1);

      /**
       * Handle RPC Method Callback.
       *
       * @param error
       * @param response
       * @returns {*}
       */
      function callbackWrapper(error, response) {
        self.debug(&#x27;methodCall-&gt;callbackWrapper&#x27;, error, response);

        if (error &amp;&amp; error.code === &quot;ENOTFOUND&quot; &amp;&amp; error.syscall === &quot;getaddrinfo&quot;) {
          error.message = &quot;Unable to connect to WordPress.&quot;;
          //return fn(error);
          return error;
        }

        // Parse Response.
        if (&#x27;string&#x27; === typeof response &amp;&amp; self.common.is_numeric(response)) {
          response = parseInt(response);
        }
        // TODO: check &quot;strict mode violation&quot;
        /*jshint validthis:true */
        callback.call(this, error, response);
      }

      this.__client.rpc.methodCall(
        method,
        args,
        callbackWrapper
      );

      // @chainable
      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  multiCall: {
    /**
     * Multiple RPC Call
     *
     * @param calls
     * @param callback
     * @returns {*}
     */
    value: function multiCall(calls, callback) {
      this.debug(&#x27;multiCall&#x27;, calls);
      this.methodCall(&#x27;system.multicall&#x27;, calls, callback);
      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  uploadFile: {
    /**
     * Get Client Methods.
     *
     * Seems to fail completely when &quot;Name&quot; is nota  valid filename..?
     *
     * ### Notes
     * * Uses &quot;wp.uploadFile&quot; RPC EP.
     *
     * ### Returns
     * * id
     * * file
     * * url
     * * type
     *
     * @param data            {Object}
     * @param data.name       {String}
     * @param data.type       {String}
     * @param data.bits       {String}
     * @param data.overwrite  {Boolean}
     * @param data.post_id    {Integer} Optional ID of parent post.
     * @param callback        {Function}
     * @returns {*}
     */
    value: function uploadFile(data, callback) {
      this.debug(&#x27;uploadFile&#x27;, data);

      var self = this;

      /**
       * Handle Upload Callback
       *
       * @param error
       * @param response
       * @returns {*}
       */
      function uploadCallback(error, response) {

        // If the user does not have the uploadFiles cap.
        if (error &amp;&amp; error.code === 401) {
          return callback.call(self, null, { ok: false, id: response.id, message: error.faultString, error: error });
        }

        // File upload failure.
        if (error &amp;&amp; error.code === 500) {
          return callback.call(self, null, { ok: false, id: response.id, message: error.faultString, error: error });
        }

        if (!error &amp;&amp; response) {
          return callback.call(self, null, { ok: true, id: parseInt(response.id), file: response.file, url: response.url, type: response.file });
        }

        // Unhandled.
        callback.call(self, null, { ok: false, id: response.ID, data: data, error: error });

      }

      data.bits = new Buffer(data.bits, &#x27;base64&#x27;);

      this.methodCall(&#x27;wp.uploadFile&#x27;, [ this.get(&#x27;blog&#x27;), this.get(&#x27;username&#x27;), this.get(&#x27;password&#x27;), data ], uploadCallback);

      return this;

    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  insertPost: {
    /**
     * Insert / Update Post
     *
     * Natively:
     * - Will return &quot;true&quot; if post has been updated.
     * - Will return an error if post has NOT been updated, even if due to &quot;if_not_modified_since&quot;.
     * - Will return ID of new post if inserted.
     *
     * @param data            {Object}
     * @param data.ID         {Integer} If set, will attempt to edit.
     * @param data.type       {String}
     * @param data.bits       {String}
     * @param data.bits       {String}
     * @param data.overwrite  {Boolean}
     * @param callback        {Function}
     * @returns {*}
     */
    value: function insertPost(data, callback) {
      this.debug(&#x27;insertPost&#x27;, data);

      var self = this;

      /**
       * Handle Insertion Callback
       *
       * @param error
       * @param response
       * @returns {*}
       */
      function insertCallback(error, response) {

        // Not modified since specified date.
        if (data.ID &amp;&amp; error &amp;&amp; error.code === 409 &amp;&amp; error.faultString) {
          return callback.call(self, null, { ok: true, id: data.ID, updated: false, message: error.faultString, error: error });
        }

        // Trying to update a post ID that does not exist.
        if (data.ID &amp;&amp; error &amp;&amp; error.code === 404 &amp;&amp; error.faultString) {
          return callback.call(self, null, { ok: false, id: data.ID, updated: false, message: error.faultString, error: error });
        }

        if (&#x27;number&#x27; === typeof response) {
          return callback.call(self, null, { ok: true, id: response, updated: false });
        }

        if (&#x27;boolean&#x27; === typeof response &amp;&amp; response === false) {
          return callback.call(self, null, { ok: false, id: data.ID, updated: false, message: error.message });
        }

        if (&#x27;boolean&#x27; === typeof response &amp;&amp; response === true) {
          return callback.call(self, null, { ok: true, id: data.ID, updated: true });
        }

        // Unhandled.
        callback.call(self, null, { ok: false, id: data.ID, data: data, error: error });

      }

      if (data.ID) {
        this.methodCall(&#x27;wp.editPost&#x27;, [ this.get(&#x27;blog&#x27;), this.get(&#x27;username&#x27;), this.get(&#x27;password&#x27;), data.ID, data ], insertCallback);
      }

      if (!data.ID) {
        this.methodCall(&#x27;wp.newPost&#x27;, [ this.get(&#x27;blog&#x27;), this.get(&#x27;username&#x27;), this.get(&#x27;password&#x27;), data ], insertCallback);
      }

      return this;

    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  getMediaItem: {
    /**
     * Get Client Methods.
     *
     * @param attachment_id
     * @param callback
     * @returns {*}
     */
    value: function getMediaItem(attachment_id, callback) {
      this.debug(&#x27;getMediaItem&#x27;, attachment_id);

      this.methodCall(&#x27;wp.getMediaItem&#x27;, [ this.get(&#x27;blog&#x27;), this.get(&#x27;username&#x27;), this.get(&#x27;password&#x27;), attachment_id ], callback);

      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  getPosts: {
    /**
     * Get Client Methods.
     *
     * @param filter
     * @param callback
     * @returns {*}
     */
    value: function getPosts(filter, callback) {
      this.debug(&#x27;getPosts&#x27;, filter);
      this.__client.getPosts(filter || { type: &#x27;post&#x27; }, callback.bind(this));
      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  getPostTypes: {
    /**
     * Get Client Methods.
     *
     * @param callback
     * @returns {*}
     */
    value: function getPostTypes(callback) {
      this.debug(&#x27;getPostTypes&#x27;);
      this.__client.getPostTypes(callback);
      return this;
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  nextTick: {
    /**
     * Call Method on Next Tick.
     *
     * @param callback
     * @returns {*}
     */
    value: function nextTick(callback) {

      var context = this;
      var args = Array.prototype.slice.call(arguments, 1);

      // Do not schedule callback if not a valid function.
      if (&#x27;function&#x27; !== typeof callback) {
        return this;
      }

      // Execute callback on next tick.
      process.nextTick(function nextTickHandler() {
        context.debug(&#x27;nextTick&#x27;, callback.name);
        callback.apply(context, args);
      });

      // @chainable
      return this;

    },
    enumerable: false,
    configurable: true,
    writable: true
  },
  debug: {
    value: require(&#x27;debug&#x27;)(&#x27;wordpress-client&#x27;),
    enumerable: false,
    configurable: true,
    writable: true
  },
  common: {
    value: require(&#x27;./common&#x27;),
    enumerable: false,
    configurable: true,
    writable: true
  }
});

/**
 * Constructor Properties.
 *
 */
Object.defineProperties(module.exports = Client, {
  version: {
    value: require(&#x27;../package&#x27;).version,
    enumerable: true,
    configurable: false,
    writable: false
  },
  common: {
    value: Client.prototype.common,
    enumerable: true,
    configurable: false,
    writable: false
  },
  defaults: {
    value: {
      username: process.env.WORDPRESS_USERNAME || undefined,
      password: process.env.WORDPRESS_PASSWORD || undefined,
      url: process.env.WORDPRESS_URL || undefined,
      methods: [],
      key: null,
      blog: 1
    },
    enumerable: true,
    configurable: true,
    writable: true
  },
  create: {
    /**
     * Create Client
     *
     * @param settings
     * @returns {Client}
     */
    value: function create(settings) {
      return new Client(settings);
    },
    enumerable: true,
    configurable: true,
    writable: true
  }
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
